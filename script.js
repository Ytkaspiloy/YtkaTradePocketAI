// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç–∏
const translations = {
    ru: {
        title: "SCALPING ROBOT PRO",
        subtitle: "–¢–æ—Ä–≥–æ–≤–ª—è –±–∏–Ω–∞—Ä–Ω—ã–º–∏ –æ–ø—Ü–∏–æ–Ω–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏",
        mode: "–†–µ–∂–∏–º: –î–µ–º–æ",
        trading_mode: "–†–ï–ñ–ò–ú –¢–û–†–ì–û–í–õ–ò",
        mode_indicators: "–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã",
        mode_smart: "Smart Money",
        instrument: "–ò–ù–°–¢–†–£–ú–ï–ù–¢",
        expiration: "–≠–ö–°–ü–ò–†–ê–¶–ò–Ø",
        indicators: "–ò–ù–î–ò–ö–ê–¢–û–†–´",
        real_quotes: "–†–ï–ê–õ–¨–ù–´–ï –ö–û–¢–ò–†–û–í–ö–ò",
        eur_usd: "EUR/USD:",
        signal: "–°–ò–ì–ù–ê–õ",
        get_signal: "–ü–û–õ–£–ß–ò–¢–¨ –°–ò–ì–ù–ê–õ",
        updating_prices: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω...",
        current_price: "–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:",
        change: "–ò–∑–º–µ–Ω–µ–Ω–∏–µ:",
        time: "–í—Ä–µ–º—è:",
        timeframe: "–¢–∞–π–º—Ñ—Ä–µ–π–º:",
        current_signal: "–¢–ï–ö–£–©–ò–ô –°–ò–ì–ù–ê–õ",
        click_for_analysis: "–ù–∞–∂–º–∏—Ç–µ '–ü–æ–ª—É—á–∏—Ç—å —Å–∏–≥–Ω–∞–ª' –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞",
        confirmations: "–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø",
        expires_in: "–ò—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑:",
        last_results: "–ü–û–°–õ–ï–î–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´",
        api_info: "–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ—Ç–∏—Ä–æ–≤–∫–∏ Forex. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥.",
        disclaimer: "–¢–æ—Ä–≥–æ–≤–ª—è –±–∏–Ω–∞—Ä–Ω—ã–º–∏ –æ–ø—Ü–∏–æ–Ω–∞–º–∏ —Å–≤—è–∑–∞–Ω–∞ —Å –≤—ã—Å–æ–∫–∏–º–∏ —Ä–∏—Å–∫–∞–º–∏."
    },
    en: {
        title: "SCALPING ROBOT PRO",
        subtitle: "Real-Time Binary Options Trading",
        mode: "Mode: Demo",
        trading_mode: "TRADING MODE",
        mode_indicators: "Indicators",
        mode_smart: "Smart Money",
        instrument: "INSTRUMENT",
        expiration: "EXPIRATION",
        indicators: "INDICATORS",
        real_quotes: "REAL QUOTES",
        eur_usd: "EUR/USD:",
        signal: "SIGNAL",
        get_signal: "GET SIGNAL",
        updating_prices: "Updating prices...",
        current_price: "Current price:",
        change: "Change:",
        time: "Time:",
        timeframe: "Timeframe:",
        current_signal: "CURRENT SIGNAL",
        click_for_analysis: "Click 'Get Signal' for analysis",
        confirmations: "CONFIRMATIONS",
        expires_in: "Expires in:",
        last_results: "LAST RESULTS",
        api_info: "Real Forex quotes are used. Update every 5 seconds.",
        disclaimer: "Binary options trading involves high risks."
    },
    es: {
        title: "SCALPING ROBOT PRO",
        subtitle: "Operaciones Binarias en Tiempo Real",
        mode: "Modo: Demo",
        trading_mode: "MODO DE OPERACI√ìN",
        mode_indicators: "Indicadores",
        mode_smart: "Smart Money",
        instrument: "INSTRUMENTO",
        expiration: "EXPIRACI√ìN",
        indicators: "INDICADORES",
        real_quotes: "COTIZACIONES REALES",
        eur_usd: "EUR/USD:",
        signal: "SE√ëAL",
        get_signal: "OBTENER SE√ëAL",
        updating_prices: "Actualizando precios...",
        current_price: "Precio actual:",
        change: "Cambio:",
        time: "Tiempo:",
        timeframe: "Timeframe:",
        current_signal: "SE√ëAL ACTUAL",
        click_for_analysis: "Haga clic en 'Obtener se√±al' para el an√°lisis",
        confirmations: "CONFIRMACIONES",
        expires_in: "Expira en:",
        last_results: "√öLTIMOS RESULTADOS",
        api_info: "Se utilizan cotizaciones reales de Forex. Actualizaci√≥n cada 5 segundos.",
        disclaimer: "El trading de opciones binarias conlleva altos riesgos."
    }
};

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
const API_CONFIG = {
    baseUrl: 'https://api.twelvedata.com',
    apiKey: 'demo',
    alternativeApis: [
        {
            name: 'frankfurter',
            url: 'https://api.frankfurter.app/latest',
            pairs: ['EURUSD', 'USDJPY', 'GBPUSD', 'AUDUSD', 'USDCAD', 'USDCHF']
        },
        {
            name: 'exchangerate',
            url: 'https://api.exchangerate-api.com/v4/latest/',
            pairs: ['USD', 'EUR', 'GBP', 'AUD', 'CAD', 'CHF', 'JPY']
        }
    ]
};

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–æ–≤
const ASSETS = {
    'EURUSD': { name: 'EUR/USD', base: 'EUR', quote: 'USD', price: 1.0830 },
    'USDJPY': { name: 'USD/JPY', base: 'USD', quote: 'JPY', price: 148.35 },
    'GBPUSD': { name: 'GBP/USD', base: 'GBP', quote: 'USD', price: 1.2650 },
    'AUDUSD': { name: 'AUD/USD', base: 'AUD', quote: 'USD', price: 0.6590 },
    'USDCAD': { name: 'USD/CAD', base: 'USD', quote: 'CAD', price: 1.3520 },
    'USDCHF': { name: 'USD/CHF', base: 'USD', quote: 'CHF', price: 0.9025 },
    'EURJPY': { name: 'EUR/JPY', base: 'EUR', quote: 'JPY', price: 160.42 },
    'GBPJPY': { name: 'GBP/JPY', base: 'GBP', quote: 'JPY', price: 187.65 }
};

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentChart = null;
let currentSignal = null;
let isSignalActive = false;
let expirationTimer = null;
let currentLanguage = 'ru';
let currentTradingMode = 'indicators';
let currentChartType = 'candlestick';
let currentAsset = 'EURUSD';
let currentTimeframe = 60;
let priceUpdateInterval = null;
let chartData = {
    labels: [],
    datasets: []
};
let drawingTools = {
    active: false,
    currentTool: null,
    drawings: []
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Scalping Robot Pro...');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —è–∑—ã–∫–∞
    initLanguage();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    initChart();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
    initEvents();
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    loadInitialPrices();
    
    // –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    startPriceUpdates();
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
    loadHistory();
    
    console.log('‚úÖ Scalping Robot Pro –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —è–∑—ã–∫–∞
function initLanguage() {
    const langButtons = document.querySelectorAll('.lang-btn');
    langButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const lang = this.dataset.lang;
            setLanguage(lang);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            langButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —è–∑—ã–∫–∞
function setLanguage(lang) {
    currentLanguage = lang;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å data-i18n
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
            element.textContent = translations[lang][key];
        }
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
function initChart() {
    const ctx = document.getElementById('trading-chart').getContext('2d');
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    generateChartData();
    
    currentChart = new Chart(ctx, {
        type: currentChartType === 'candlestick' ? 'candlestick' : 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(42, 54, 85, 0.5)' },
                    ticks: { color: '#8b9dc3' }
                },
                y: {
                    position: 'right',
                    grid: { color: 'rgba(42, 54, 85, 0.5)' },
                    ticks: { color: '#8b9dc3' }
                }
            }
        }
    });
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
function generateChartData() {
    const labels = [];
    const open = [];
    const high = [];
    const low = [];
    const close = [];
    
    const now = new Date();
    let currentPrice = ASSETS[currentAsset].price;
    
    for (let i = 100; i >= 0; i--) {
        const time = new Date(now);
        time.setMinutes(time.getMinutes() - i);
        labels.push(time.getHours().toString().padStart(2, '0') + ':' + 
                    time.getMinutes().toString().padStart(2, '0'));
        
        const basePrice = i === 100 ? currentPrice : close[close.length - 1];
        const volatility = 0.0005;
        
        const o = basePrice;
        const h = o * (1 + Math.random() * volatility);
        const l = o * (1 - Math.random() * volatility);
        const c = l + Math.random() * (h - l);
        
        open.push(o);
        high.push(h);
        low.push(l);
        close.push(c);
    }
    
    if (currentChartType === 'candlestick') {
        chartData = {
            labels: labels,
            datasets: [{
                label: 'Price',
                data: close.map((c, i) => ({
                    x: labels[i],
                    o: open[i],
                    h: high[i],
                    l: low[i],
                    c: c
                })),
                color: {
                    up: '#00ff88',
                    down: '#ff4444',
                    unchanged: '#8b9dc3'
                }
            }]
        };
    } else {
        chartData = {
            labels: labels,
            datasets: [{
                label: 'Price',
                data: close,
                borderColor: '#00ff88',
                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        };
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
function initEvents() {
    console.log('üéØ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π...');
    
    // –í—ã–±–æ—Ä –∞–∫—Ç–∏–≤–∞
    document.getElementById('asset-select').addEventListener('change', function() {
        currentAsset = this.value;
        console.log('üìä –ê–∫—Ç–∏–≤ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞:', currentAsset);
        updateAssetDisplay();
        updateChart();
    });
    
    // –ö–Ω–æ–ø–∫–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTimeframe = parseInt(this.dataset.time);
            document.getElementById('current-tf').textContent = getTimeframeText(currentTimeframe);
            console.log('‚è±Ô∏è –¢–∞–π–º—Ñ—Ä–µ–π–º –∏–∑–º–µ–Ω–µ–Ω –Ω–∞:', getTimeframeText(currentTimeframe));
        });
    });
    
    // –†–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤–ª–∏
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTradingMode = this.dataset.mode;
            console.log('üéÆ –†–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω –Ω–∞:', currentTradingMode);
        });
    });
    
    // –¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞
    document.querySelectorAll('.chart-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentChartType = this.dataset.type;
            console.log('üìà –¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞:', currentChartType);
            updateChart();
        });
    });
    
    // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    document.querySelectorAll('.draw-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tool = this.dataset.tool;
            if (tool === 'clear') {
                drawingTools.drawings = [];
                updateChart();
            } else {
                drawingTools.active = !drawingTools.active;
                drawingTools.currentTool = drawingTools.active ? tool : null;
                document.querySelectorAll('.draw-btn').forEach(b => b.classList.remove('active'));
                if (drawingTools.active) {
                    this.classList.add('active');
                }
            }
            console.log('‚úèÔ∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–∏—Å–æ–≤–∞–Ω–∏—è:', drawingTools.currentTool || '–æ—Ç–∫–ª—é—á–µ–Ω');
        });
    });
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–∞
    document.getElementById('generate-signal').addEventListener('click', generateSignal);
    
    console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
function updateChart() {
    if (!currentChart) return;
    
    generateChartData();
    currentChart.config.type = currentChartType === 'candlestick' ? 'candlestick' : 'line';
    currentChart.data = chartData;
    currentChart.update();
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
function getTimeframeText(seconds) {
    const minutes = Math.floor(seconds / 60);
    return `${minutes} –º–∏–Ω`;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω
async function loadInitialPrices() {
    console.log('üì° –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω...');
    try {
        await fetchRealPrices();
    } catch (error) {
        console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ');
        useDemoPrices();
    }
    updateAssetDisplay();
    updatePriceFeed();
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω
async function fetchRealPrices() {
    try {
        const response = await fetch('https://api.frankfurter.app/latest?from=USD');
        if (!response.ok) throw new Error('API error');
        
        const data = await response.json();
        if (data.rates) {
            // EUR/USD
            if (data.rates.EUR) ASSETS.EURUSD.price = 1 / data.rates.EUR;
            // USD/JPY
            if (data.rates.JPY) ASSETS.USDJPY.price = data.rates.JPY;
            // GBP/USD
            if (data.rates.GBP) ASSETS.GBPUSD.price = 1 / data.rates.GBP;
            // AUD/USD
            if (data.rates.AUD) ASSETS.AUDUSD.price = 1 / data.rates.AUD;
            // USD/CAD
            if (data.rates.CAD) ASSETS.USDCAD.price = data.rates.CAD;
            // USD/CHF
            if (data.rates.CHF) ASSETS.USDCHF.price = data.rates.CHF;
            // EUR/JPY
            if (data.rates.EUR && data.rates.JPY) ASSETS.EURJPY.price = (1 / data.rates.EUR) * data.rates.JPY;
            // GBP/JPY
            if (data.rates.GBP && data.rates.JPY) ASSETS.GBPJPY.price = (1 / data.rates.GBP) * data.rates.JPY;
            
            console.log('‚úÖ –†–µ–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            return true;
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω:', error);
        throw error;
    }
}

// –î–µ–º–æ —Ü–µ–Ω—ã
function useDemoPrices() {
    Object.keys(ASSETS).forEach(asset => {
        const change = (Math.random() - 0.5) * 0.001;
        ASSETS[asset].price *= (1 + change);
    });
}

// –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω
function startPriceUpdates() {
    priceUpdateInterval = setInterval(async () => {
        try {
            await updatePrices();
            updateAssetDisplay();
            updatePriceFeed();
            updateChartWithNewData();
        } catch (error) {
            console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω:', error);
            useDemoPrices();
            updateAssetDisplay();
            updatePriceFeed();
        }
    }, 5000);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω
async function updatePrices() {
    try {
        await fetchRealPrices();
    } catch (error) {
        useDemoPrices();
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞
function updateChartWithNewData() {
    if (!currentChart || !chartData.labels) return;
    
    const asset = ASSETS[currentAsset];
    const newPrice = asset.price;
    
    if (currentChartType === 'candlestick') {
        const lastCandle = chartData.datasets[0].data[chartData.datasets[0].data.length - 1];
        const newCandle = {
            x: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            o: lastCandle.c,
            h: Math.max(lastCandle.c, newPrice),
            l: Math.min(lastCandle.c, newPrice),
            c: newPrice
        };
        
        chartData.datasets[0].data.push(newCandle);
        chartData.labels.push(newCandle.x);
        
        if (chartData.datasets[0].data.length > 100) {
            chartData.datasets[0].data.shift();
            chartData.labels.shift();
        }
    } else {
        chartData.datasets[0].data.push(newPrice);
        chartData.labels.push(new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
        
        if (chartData.datasets[0].data.length > 100) {
            chartData.datasets[0].data.shift();
            chartData.labels.shift();
        }
    }
    
    currentChart.update('none');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∞
function updateAssetDisplay() {
    const asset = ASSETS[currentAsset];
    if (!asset) return;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    document.getElementById('current-price').textContent = asset.price.toFixed(5);
    document.getElementById('current-pair').textContent = asset.name;
    document.getElementById('current-price-display').textContent = asset.price.toFixed(5);
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
    const changePercent = (Math.random() - 0.5) * 0.1;
    const changeElement = document.getElementById('price-change');
    changeElement.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
    changeElement.className = changePercent >= 0 ? 'positive' : 'negative';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    document.getElementById('price-change-display').textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
    document.getElementById('price-time').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
    document.getElementById('chart-time').textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})} UTC`;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ–Ω—Ç—ã —Ü–µ–Ω
function updatePriceFeed() {
    ['EURUSD', 'USDJPY', 'GBPUSD'].forEach(pair => {
        const element = document.getElementById(`price-${pair}`);
        if (element && ASSETS[pair]) {
            element.textContent = ASSETS[pair].price.toFixed(5);
        }
    });
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–∞
async function generateSignal() {
    if (isSignalActive) {
        alert(translations[currentLanguage].updating_prices || '–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–∏–≥–Ω–∞–ª–∞');
        return;
    }
    
    isSignalActive = true;
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    const btn = document.getElementById('generate-signal');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + 
                    (translations[currentLanguage].updating_prices || '–ê–ù–ê–õ–ò–ó –†–´–ù–ö–ê...');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    updateSignalStatus('–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞...', '#ffaa00');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    showAnalysisAnimation();
    
    // –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞
    setTimeout(() => {
        createSignal();
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-bolt"></i> ' + 
                       (translations[currentLanguage].get_signal || '–ü–û–õ–£–ß–ò–¢–¨ –°–ò–ì–ù–ê–õ');
    }, 3000);
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –∞–Ω–∞–ª–∏–∑–∞
function showAnalysisAnimation() {
    document.getElementById('signal-content').innerHTML = `
        <div style="text-align: center;">
            <div style="display: inline-block; width: 60px; height: 60px; border: 3px solid #2a3655; border-top-color: #00ff88; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; color: #8b9dc3; font-size: 14px;">
                <i class="fas fa-chart-line"></i><br>
                –ê–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–æ—Ç–∏—Ä–æ–≤–æ–∫...
            </p>
            <div style="margin-top: 10px; font-size: 12px; color: #5d6d97;">
                –†–µ–∂–∏–º: ${currentTradingMode === 'indicators' ? '–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã' : 'Smart Money'}
            </div>
        </div>
    `;
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞
function createSignal() {
    const asset = ASSETS[currentAsset];
    
    // –ê–Ω–∞–ª–∏–∑ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
    const analysis = currentTradingMode === 'indicators' 
        ? performTechnicalAnalysis() 
        : performSmartMoneyAnalysis();
    
    // –°–æ–∑–¥–∞–µ–º —Å–∏–≥–Ω–∞–ª
    currentSignal = {
        asset: currentAsset,
        pair: asset.name,
        direction: analysis.direction,
        entryPrice: asset.price,
        confidence: analysis.confidence,
        analysis: analysis,
        timestamp: new Date(),
        result: null
    };
    
    console.log('üéØ –°–æ–∑–¥–∞–Ω —Å–∏–≥–Ω–∞–ª:', currentSignal);
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–∏–≥–Ω–∞–ª
    displaySignal();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    displayConfirmations(analysis.confirmations);
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
    startExpirationTimer();
}

// –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
function performTechnicalAnalysis() {
    const confirmations = [];
    
    // RSI –∞–Ω–∞–ª–∏–∑
    const rsiValue = 30 + Math.random() * 50;
    if (rsiValue < 30) {
        confirmations.push({ 
            text: 'RSI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å', 
            type: 'BUY', 
            confidence: 85 
        });
    } else if (rsiValue > 70) {
        confirmations.push({ 
            text: 'RSI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å', 
            type: 'SELL', 
            confidence: 85 
        });
    }
    
    // MACD –∞–Ω–∞–ª–∏–∑
    const macdSignal = Math.random() > 0.5 ? 'BUY' : 'SELL';
    confirmations.push({ 
        text: `MACD —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç ${macdSignal === 'BUY' ? '–æ –ø–æ–∫—É–ø–∫–µ' : '–æ –ø—Ä–æ–¥–∞–∂–µ'}`, 
        type: macdSignal, 
        confidence: 75 
    });
    
    // Moving Average
    const maSignal = Math.random() > 0.5 ? 'BUY' : 'SELL';
    confirmations.push({ 
        text: `–°–∫–æ–ª—å–∑—è—â–∏–µ —Å—Ä–µ–¥–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç ${maSignal === 'BUY' ? '–≤–æ—Å—Ö–æ–¥—è—â–∏–π' : '–Ω–∏—Å—Ö–æ–¥—è—â–∏–π'} —Ç—Ä–µ–Ω–¥`, 
        type: maSignal, 
        confidence: 80 
    });
    
    // –û–±—ä–µ–º—ã
    confirmations.push({ 
        text: '–û–±—ä–µ–º—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –¥–≤–∏–∂–µ–Ω–∏–µ', 
        type: Math.random() > 0.5 ? 'BUY' : 'SELL', 
        confidence: 70 
    });
    
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞/–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ
    confirmations.push({ 
        text: '–¶–µ–Ω–∞ –æ—Ç—Å–∫–æ—á–∏–ª–∞ –æ—Ç –∫–ª—é—á–µ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è', 
        type: Math.random() > 0.5 ? 'BUY' : 'SELL', 
        confidence: 82 
    });
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–µ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    const buyCount = confirmations.filter(c => c.type === 'BUY').length;
    const sellCount = confirmations.filter(c => c.type === 'SELL').length;
    const direction = buyCount > sellCount ? 'BUY' : 'SELL';
    
    // –°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
    const avgConfidence = Math.round(
        confirmations.reduce((sum, c) => sum + c.confidence, 0) / confirmations.length
    );
    
    return {
        direction,
        confidence: Math.min(95, avgConfidence + 5),
        confirmations,
        rsi: rsiValue,
        macdSignal,
        maSignal
    };
}

// Smart Money –∞–Ω–∞–ª–∏–∑
function performSmartMoneyAnalysis() {
    const confirmations = [];
    
    // –û—Ä–¥–µ—Ä–±—É–∫ –∞–Ω–∞–ª–∏–∑
    confirmations.push({ 
        text: '–ö—Ä—É–ø–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –Ω–∞ –ø–æ–∫—É–ø–∫—É', 
        type: 'BUY', 
        confidence: 88 
    });
    
    // –£—Ä–æ–≤–Ω–∏ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
    confirmations.push({ 
        text: '–õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å —Å–º–µ—â–µ–Ω–∞ –≤ —Å—Ç–æ—Ä–æ–Ω—É –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π', 
        type: 'BUY', 
        confidence: 85 
    });
    
    // –ö–ª–∞—Å—Ç–µ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    confirmations.push({ 
        text: '–ö–ª–∞—Å—Ç–µ—Ä—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ', 
        type: Math.random() > 0.3 ? 'BUY' : 'SELL', 
        confidence: 82 
    });
    
    // Delta –∞–Ω–∞–ª–∏–∑
    confirmations.push({ 
        text: '–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –¥–µ–ª—å—Ç–∞', 
        type: 'BUY', 
        confidence: 87 
    });
    
    // –ü–æ–∑–∏—Ü–∏–∏ –∏–Ω—Å—Ç–∏—Ç—É—Ü–∏–æ–Ω–∞–ª–æ–≤
    confirmations.push({ 
        text: '–ò–Ω—Å—Ç–∏—Ç—É—Ç—ã —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –¥–ª–∏–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏', 
        type: 'BUY', 
        confidence: 90 
    });
    
    const direction = Math.random() > 0.3 ? 'BUY' : 'SELL';
    const avgConfidence = Math.round(
        confirmations.reduce((sum, c) => sum + c.confidence, 0) / confirmations.length
    );
    
    return {
        direction,
        confidence: Math.min(97, avgConfidence + 7),
        confirmations
    };
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞
function displaySignal() {
    const signal = currentSignal;
    
    document.getElementById('signal-content').style.display = 'none';
    document.getElementById('signal-details').style.display = 'block';
    document.getElementById('confirmations-panel').style.display = 'block';
    document.getElementById('expiration-timer').style.display = 'block';
    
    const detailsHTML = `
        <div style="padding: 20px;">
            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #8b9dc3; font-size: 13px;">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:</span>
                <span style="font-weight: 700; font-size: 16px;">${signal.pair}</span>
            </div>
            
            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #8b9dc3; font-size: 13px;">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</span>
                <span style="font-weight: 800; font-size: 18px; color: ${signal.direction === 'BUY' ? '#00ff88' : '#ff4444'}; text-transform: uppercase;">
                    ${signal.direction === 'BUY' ? '–ü–û–ö–£–ü–ö–ê' : '–ü–†–û–î–ê–ñ–ê'}
                </span>
            </div>
            
            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #8b9dc3; font-size: 13px;">–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞:</span>
                <span style="font-weight: 700; font-family: 'Courier New', monospace; font-size: 16px;">
                    ${signal.entryPrice.toFixed(5)}
                </span>
            </div>
            
            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #8b9dc3; font-size: 13px;">–¢–æ—á–Ω–æ—Å—Ç—å:</span>
                <span style="font-weight: 800; color: #00ff88; font-size: 18px;">
                    ${signal.confidence}%
                </span>
            </div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(42, 54, 85, 0.5);">
                <div style="font-size: 11px; color: #5d6d97; text-align: center;">
                    <i class="far fa-clock"></i>
                    ${signal.timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('signal-details').innerHTML = detailsHTML;
    updateSignalStatus('–ê–ö–¢–ò–í–ï–ù', signal.direction === 'BUY' ? '#00ff88' : '#ff4444');
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
function displayConfirmations(confirmations) {
    const grid = document.getElementById('confirmations-grid');
    grid.innerHTML = '';
    
    confirmations.forEach(conf => {
        const item = document.createElement('div');
        item.className = `confirmation-item ${conf.type === 'BUY' ? 'positive' : 'negative'}`;
        item.innerHTML = `
            <div class="confirmation-icon">
                <i class="fas fa-${conf.type === 'BUY' ? 'check-circle' : 'exclamation-circle'}"></i>
            </div>
            <div class="confirmation-text">${conf.text} (${conf.confidence}%)</div>
        `;
        grid.appendChild(item);
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
function updateSignalStatus(text, color) {
    const statusElement = document.getElementById('signal-status');
    const statusText = document.getElementById('status-text');
    
    if (statusElement && statusText) {
        const dot = statusElement.querySelector('.status-dot');
        if (dot) {
            dot.style.background = color;
            dot.style.boxShadow = `0 0 10px ${color}`;
        }
        statusText.textContent = text;
        statusText.style.color = color;
    }
}

// –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏
function startExpirationTimer() {
    const totalTime = currentTimeframe;
    let timeLeft = totalTime;
    
    const timerBar = document.getElementById('timer-bar');
    const timerValue = document.getElementById('timer-value');
    
    if (!timerBar || !timerValue) return;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    timerBar.style.transition = 'none';
    timerBar.style.transform = 'scaleX(1)';
    void timerBar.offsetWidth;
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é –∞–Ω–∏–º–∞—Ü–∏—é
    timerBar.style.transition = `transform ${totalTime}s linear`;
    timerBar.style.transform = 'scaleX(0)';
    
    // –¢–∞–π–º–µ—Ä
    expirationTimer = setInterval(() => {
        timeLeft--;
        
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerValue.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        const progress = timeLeft / totalTime;
        if (progress < 0.3) {
            timerBar.style.background = 'linear-gradient(90deg, #ff4444, #ffaa00)';
        } else if (progress < 0.7) {
            timerBar.style.background = 'linear-gradient(90deg, #ffaa00, #00ff88)';
        }
        
        if (timeLeft <= 0) {
            clearInterval(expirationTimer);
            finishSignal();
        }
    }, 1000);
}

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞
function finishSignal() {
    if (!currentSignal) return;
    
    const currentPrice = ASSETS[currentAsset].price;
    const entryPrice = currentSignal.entryPrice;
    
    let result, resultColor, resultText;
    
    if (currentSignal.direction === 'BUY') {
        if (currentPrice > entryPrice * 1.0001) {
            result = 'WIN';
            resultColor = '#00ff88';
            resultText = '–í–´–ò–ì–†–´–®';
        } else if (currentPrice < entryPrice * 0.9999) {
            result = 'LOSS';
            resultColor = '#ff4444';
            resultText = '–ü–†–û–ò–ì–†–´–®';
        } else {
            result = 'REFUND';
            resultColor = '#8b9dc3';
            resultText = '–í–û–ó–í–†–ê–¢';
        }
    } else {
        if (currentPrice < entryPrice * 0.9999) {
            result = 'WIN';
            resultColor = '#00ff88';
            resultText = '–í–´–ò–ì–†–´–®';
        } else if (currentPrice > entryPrice * 1.0001) {
            result = 'LOSS';
            resultColor = '#ff4444';
            resultText = '–ü–†–û–ò–ì–†–´–®';
        } else {
            result = 'REFUND';
            resultColor = '#8b9dc3';
            resultText = '–í–û–ó–í–†–ê–¢';
        }
    }
    
    currentSignal.result = result;
    currentSignal.exitPrice = currentPrice;
    currentSignal.completedAt = new Date();
    
    showSignalResult(result, resultText, resultColor, currentPrice);
    addToHistory();
    
    setTimeout(resetSignal, 5000);
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
function showSignalResult(result, resultText, resultColor, exitPrice) {
    const resultHTML = `
        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid ${resultColor}30;">
            <div style="text-align: center;">
                <div style="font-size: 28px; font-weight: 800; color: ${resultColor}; margin-bottom: 5px;">
                    ${resultText}
                </div>
                <div style="font-size: 14px; color: #8b9dc3; margin-bottom: 15px;">
                    –°–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω
                </div>
                
                <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 11px; color: #5d6d97;">–í—Ö–æ–¥</div>
                        <div style="font-size: 16px; font-weight: 700;">${currentSignal.entryPrice.toFixed(5)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 11px; color: #5d6d97;">–í—ã—Ö–æ–¥</div>
                        <div style="font-size: 16px; font-weight: 700;">${exitPrice.toFixed(5)}</div>
                    </div>
                </div>
                
                <div style="font-size: 12px; color: #5d6d97;">
                    <i class="far fa-clock"></i>
                    ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('signal-details').innerHTML += resultHTML;
    updateSignalStatus(resultText, resultColor);
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
function addToHistory() {
    const resultsList = document.getElementById('results-list');
    if (!resultsList) return;
    
    const resultColor = currentSignal.result === 'WIN' ? '#00ff88' : 
                       currentSignal.result === 'LOSS' ? '#ff4444' : '#8b9dc3';
    
    const historyItem = document.createElement('div');
    historyItem.className = `result-item ${currentSignal.result.toLowerCase()}`;
    historyItem.style.cssText = `
        animation: fadeIn 0.3s ease-out;
    `;
    
    historyItem.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-weight: 700; min-width: 70px;">${currentSignal.pair}</span>
            <span style="color: ${currentSignal.direction === 'BUY' ? '#00ff88' : '#ff4444'}; font-weight: 600;">
                ${currentSignal.direction === 'BUY' ? '–ü–û–ö–£–ü–ö–ê' : '–ü–†–û–î–ê–ñ–ê'}
            </span>
            <span style="color: ${resultColor}; font-weight: 800;">
                ${currentSignal.result === 'WIN' ? '–í–´–ò–ì–†–´–®' : currentSignal.result === 'LOSS' ? '–ü–†–û–ò–ì–†–´–®' : '–í–û–ó–í–†–ê–¢'}
            </span>
        </div>
        <div style="color: #5d6d97; font-size: 11px; text-align: right;">
            <div>${currentSignal.entryPrice.toFixed(5)} ‚Üí ${currentSignal.exitPrice.toFixed(5)}</div>
            <div>${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>
    `;
    
    resultsList.insertBefore(historyItem, resultsList.firstChild);
    saveHistory();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
function saveHistory() {
    try {
        let savedHistory = JSON.parse(localStorage.getItem('tradingHistory') || '[]');
        savedHistory.unshift(currentSignal);
        
        if (savedHistory.length > 50) {
            savedHistory = savedHistory.slice(0, 50);
        }
        
        localStorage.setItem('tradingHistory', JSON.stringify(savedHistory));
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:', error);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
function loadHistory() {
    try {
        const savedHistory = JSON.parse(localStorage.getItem('tradingHistory') || '[]');
        const resultsList = document.getElementById('results-list');
        
        savedHistory.slice(0, 10).forEach(signal => {
            if (!signal || !signal.result) return;
            
            const resultColor = signal.result === 'WIN' ? '#00ff88' : 
                              signal.result === 'LOSS' ? '#ff4444' : '#8b9dc3';
            
            const historyItem = document.createElement('div');
            historyItem.className = `result-item ${signal.result.toLowerCase()}`;
            
            historyItem.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: 700; min-width: 70px;">${signal.pair || 'N/A'}</span>
                    <span style="color: ${signal.direction === 'BUY' ? '#00ff88' : '#ff4444'}; font-weight: 600;">
                        ${signal.direction === 'BUY' ? '–ü–û–ö–£–ü–ö–ê' : '–ü–†–û–î–ê–ñ–ê'}
                    </span>
                    <span style="color: ${resultColor}; font-weight: 800;">
                        ${signal.result === 'WIN' ? '–í–´–ò–ì–†–´–®' : signal.result === 'LOSS' ? '–ü–†–û–ò–ì–†–´–®' : '–í–û–ó–í–†–ê–¢'}
                    </span>
                </div>
                <div style="color: #5d6d97; font-size: 11px; text-align: right;">
                    <div>${signal.entryPrice ? signal.entryPrice.toFixed(5) : '0.00000'} ‚Üí ${signal.exitPrice ? signal.exitPrice.toFixed(5) : '0.00000'}</div>
                    <div>${signal.completedAt ? new Date(signal.completedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '00:00'}</div>
                </div>
            `;
            
            if (resultsList) {
                resultsList.appendChild(historyItem);
            }
        });
        
        console.log(`üìö –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Math.min(savedHistory.length, 10)} –∑–∞–ø–∏—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏`);
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
    }
}

// –°–±—Ä–æ—Å —Å–∏–≥–Ω–∞–ª–∞
function resetSignal() {
    isSignalActive = false;
    currentSignal = null;
    
    document.getElementById('signal-content').style.display = 'flex';
    document.getElementById('signal-details').style.display = 'none';
    document.getElementById('confirmations-panel').style.display = 'none';
    document.getElementById('expiration-timer').style.display = 'none';
    
    document.getElementById('signal-content').innerHTML = `
        <div class="signal-placeholder">
            <i class="fas fa-chart-line"></i>
            <p data-i18n="click_for_analysis">–ù–∞–∂–º–∏—Ç–µ "–ü–æ–ª—É—á–∏—Ç—å —Å–∏–≥–Ω–∞–ª" –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>
        </div>
    `;
    
    updateSignalStatus('–û–∂–∏–¥–∞–Ω–∏–µ', '#00ff88');
    
    const timerBar = document.getElementById('timer-bar');
    const timerValue = document.getElementById('timer-value');
    if (timerBar && timerValue) {
        timerBar.style.transition = 'none';
        timerBar.style.transform = 'scaleX(1)';
        timerBar.style.background = 'linear-gradient(90deg, #00ff88, #0066ff)';
        timerValue.textContent = getTimeframeText(currentTimeframe);
    }
    
    if (expirationTimer) {
        clearInterval(expirationTimer);
        expirationTimer = null;
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏–∏
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .live-price {
        animation: pulse 2s infinite;
    }
`;
document.head.appendChild(style);

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
window.debug = {
    getCurrentPrice: () => ASSETS[currentAsset].price,
    getAssetInfo: () => ASSETS[currentAsset],
    getAllPrices: () => ASSETS,
    forcePriceUpdate: updatePrices,
    simulateSignal: generateSignal,
    setLanguage: setLanguage
};
